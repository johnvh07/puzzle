<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
  <title>Puzzle - Upload</title>
</head>
<body>
  <form method="post" enctype="multipart/form-data">
    <p><input id="upload" name="video" type="file" accept="video/*"></input></p>
    <p>Save this video with the name: <input id="filename" name="filename" type="text"></input></p>
    <p>
      Trim video to start at
      <input id="starttime" name="starttime" type="number" min="0" step="0.001" style="width:5em"></input> seconds and end at
      <input id="endtime" name="endtime" type="number" min="0" step="0.001" style="width:5em"></input> seconds.  (1-2 second videos are best.)
    </p>
    <p>The name of the street where our family home is: <input name="streetname" type="text"></input></p>
    <p><input type="submit" value="Upload!" formaction="/upload"></input></p>
  </form>
  <hr>
  <video id="video" controls playsinline muted autoplay style="max-width:100%;max-height:100vh;display:none"></video>
  <p id="video_info"></p>
  <hr>
  <p id="output" style="font-family:monospace"></p>
  <p>Instructions for iPhone live photos: Open the live photo in the Photos app, swipe to see options, and choose "bounce" mode to convert the live photo to a video before uploading here.  If your screen becomes dominated by the video while uploading, try rotating your phone.  The puzzle itself will automatically bounce the video (ie, play it forwards and then backwards), so it's best to trim off the second half.</p>
  <p>Instructions for Macbook live photos: Open the live photo in the Photos app, and click File -&gt; Export -&gt; "Export Original" and click "Export", which should put a ".mov" movie on your Desktop.</p>
  <script>
    document.querySelector('#starttime').value = 0;  // This value gets retained on reload, so set it to 0.
    document.querySelector('#upload').addEventListener('change', function() {
      const filelist = [].slice.call(this.files);
      window._d = {filelist};
      document.querySelector('#output').innerHTML = filelist.map((f,idx) => `files[${idx}] = {size:${f.size.toLocaleString()} bytes, type:${f.type}}`).join('<br>');
      if (filelist.length === 1 && filelist[0].type.startsWith('video/')) {
        document.querySelector('#filename').value = /[^\.]+/.exec(filelist[0].name) || (Math.random()*1e6).toFixed(0);
        const video_elem = document.querySelector('#video');
        video_elem.style.display = 'inherit';
        video_elem.volume = 0;
        video_elem.addEventListener('timeupdate', () => {
          document.querySelector('#video_info').innerHTML = `${video_elem.currentTime.toFixed(3)} / ${video_elem.duration.toFixed(3)}`
        });
        const object_url = URL.createObjectURL(filelist[0]);
        video_elem.src = object_url;
        video_elem.addEventListener('loadedmetadata', () => {
          document.querySelector('#endtime').value = video_elem.duration.toFixed(3);
        })
        setTimeout(() => URL.revokeObjectURL(object_url), 100);  // I think it's ok to revoke this after the video fully loads
      }
    });
  </script>
</body>
</html>
